import{r as s,a as P,k as b,s as g}from"./index-Dt07UTka.js";const M={protocol1:{score:0,status:"pending",validationPrerequis:0,evaluationMTP:0,entretien:0,data:null},protocol2:{score:0,status:"pending",miseEnSituation:0,validationOperationnelle:0,analyseCompetences:0,data:null},globalScore:0,finalStatus:"pending",pointsForts:"",pointsAmelioration:""};function k(t){const[S,l]=s.useState(M),[f,m]=s.useState(!0),{user:r}=P(),{toast:u}=b(),d=s.useCallback((e,a)=>{const n=Math.min(e,100),o=Math.min(a,100);return Math.min(Math.round((n*.4+o*.6)*10)/10,100)},[]),i=s.useCallback(e=>{const a=e.filter(n=>n>0);return a.length===0?0:Math.round(a.reduce((n,o)=>n+o,0)/a.length)},[]),_=s.useCallback(async()=>{if(!t||!r)return null;try{const{data:e,error:a}=await g.from("protocol1_evaluations").select("*").eq("application_id",t).maybeSingle();if(a&&a.code!=="PGRST116")throw a;if(e){const n={status:e.completed?"completed":"in_progress",validation_prerequis:{score:e.documentary_score||0,comments:e.cv_comments||""},evaluation_mtp:{score:e.metier_score||0,comments:e.metier_comments||""},entretien:{score:e.interview_score||0,comments:e.interview_metier_comments||""}};return{data:n,score:e.overall_score||0,status:n.status,validationPrerequis:i([e.cv_score||0,e.lettre_motivation_score||0,e.diplomes_certificats_score||0]),evaluationMTP:i([e.metier_score||0,e.talent_score||0,e.paradigme_score||0]),entretien:i([e.interview_metier_score||0,e.interview_talent_score||0,e.interview_paradigme_score||0])}}return null}catch(e){return console.error("Erreur lors du chargement des données Protocol 1:",e),null}},[t,r,i]),v=s.useCallback(async()=>{if(!t||!r)return null;try{const{data:e,error:a}=await g.from("protocol2_evaluations").select("*").eq("application_id",t).maybeSingle();if(a&&a.code!=="PGRST116")throw a;if(e){const n={status:e.completed?"completed":"in_progress",mise_en_situation:{jeu_de_role:{score:e.qcm_role_score||0,comments:e.interview_notes||""},jeu_codir:{score:e.qcm_codir_score||0,comments:e.visit_notes||""}},validation_operationnelle:{fiche_kpis:{score:e.overall_score||0,comments:e.skills_gap_notes||""}},analyse_competences:{gap_competences:{score:e.overall_score||0,comments:e.skills_gap_notes||"",gapLevel:e.skills_gap_level||""},plan_formation:{score:e.overall_score||0,comments:e.skills_gap_notes||""}}};return{data:n,score:e.overall_score||0,status:n.status,miseEnSituation:i([e.qcm_role_score||0,e.qcm_codir_score||0]),validationOperationnelle:e.overall_score?Math.round(Math.min(e.overall_score/20,5)):0,analyseCompetences:e.overall_score?Math.round(Math.min(e.overall_score/20,5)):0}}return null}catch(e){return console.error("Erreur lors du chargement des données Protocol 2:",e),null}},[t,r,i]),h=s.useCallback(async()=>{if(!(!t||!r)){m(!0);try{const[e,a]=await Promise.all([_(),v()]),n=Math.min((e==null?void 0:e.score)||0,100),o=Math.min((a==null?void 0:a.score)||0,100),c=d(n,o);l({protocol1:{score:n,status:(e==null?void 0:e.status)||"pending",validationPrerequis:(e==null?void 0:e.validationPrerequis)||0,evaluationMTP:(e==null?void 0:e.evaluationMTP)||0,entretien:(e==null?void 0:e.entretien)||0,data:(e==null?void 0:e.data)||null},protocol2:{score:o,status:(a==null?void 0:a.status)||"pending",miseEnSituation:(a==null?void 0:a.miseEnSituation)||0,validationOperationnelle:(a==null?void 0:a.validationOperationnelle)||0,analyseCompetences:(a==null?void 0:a.analyseCompetences)||0,data:(a==null?void 0:a.data)||null},globalScore:c,finalStatus:c>=70?"embauche":c>=50?"incubation":"refuse",pointsForts:"",pointsAmelioration:""}),console.log("Données de synthèse chargées:",{protocol1:{score:n+"%",status:e==null?void 0:e.status,validationPrerequis:(e==null?void 0:e.validationPrerequis)+"/5",evaluationMTP:(e==null?void 0:e.evaluationMTP)+"/5",entretien:(e==null?void 0:e.entretien)+"/5",source:"Score déjà calculé dans Protocol 1 (overall_score)"},protocol2:{score:o+"%",status:a==null?void 0:a.status,miseEnSituation:(a==null?void 0:a.miseEnSituation)+"/5",validationOperationnelle:(a==null?void 0:a.validationOperationnelle)+"/5",analyseCompetences:(a==null?void 0:a.analyseCompetences)+"/5",source:"Score déjà calculé en pourcentage dans Protocol 2 (overall_score)"},globalScore:c+"%",finalStatus:c>=70?"embauche":c>=50?"incubation":"refuse"})}catch(e){console.error("Erreur lors du chargement des données de synthèse:",e),u({title:"Erreur de chargement",description:"Impossible de charger les données de synthèse",variant:"destructive"})}finally{m(!1)}}},[t,r,_,v,d,u]),y=s.useCallback((e,a)=>{l(n=>({...n,pointsForts:e,pointsAmelioration:a}))},[]);return s.useEffect(()=>{t&&r&&h()},[t,r,h]),{synthesisData:S,isLoading:f,updateRecommendations:y}}export{k as u};
